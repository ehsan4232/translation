In Figure 12-13, user A has two devices: a phone and a laptop. When User A logs in to the chat app with her phone, it establishes a WebSocket connection with Chat server 1. Similarly, there is a connection between the laptop and Chat server 1. Each device maintains a variable called cur_max_message_id, which keeps track of the latest message ID on the device. Messages that satisfy the following two conditions are considered as news messages: • The recipient ID is equal to the currently logged-in user ID. • Message ID in the key-value store is larger than cur_max_message_id . With distinct cur_max_message_id on each device, message synchronization is easy as each device can get new messages from the KV store. Small group chat flow In comparison to the one-on-one chat, the logic of group chat is more complicated. Figures 12-14 and 12-15 explain the flow.